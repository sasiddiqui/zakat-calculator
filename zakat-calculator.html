<!--
TODO:
   - currencies 
   - madhhabs
   - FAQ 
   
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
    <style>
        /* Remove up/down arrows from number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Result message animations */
        .result-appear {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto flex flex-col lg:flex-row gap-4 items-start justify-center">
    <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-4">Zakat Calculator</h1>

            <form id="zakat-form" class="space-y-6">
                <button type="button" id="calculate-button" class="w-full bg-blue-500 text-white p-2 rounded font-semibold hover:bg-blue-600">Calculate</button>
            </form>

            <div id="result" class="mt-4 text-center text-lg font-semibold"></div>
            </div>

        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 shadow-lg rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">Nisab Type</h3>
            <div class="grid grid-cols-2 gap-8">
                <div class="bg-white rounded-xl p-4 shadow-sm relative group cursor-pointer nisab-card" onclick="setNisabType('gold')" data-type="gold">
                    <div class="absolute inset-0 border-2 border-transparent rounded-xl transition-all duration-200"></div>
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                        </svg>
                        <h4 class="text-lg font-semibold text-gray-800">Gold</h4>
                    </div>
                    <div class="space-y-1 text-center">
                        <p class="text-gray-600">Price: <span class="font-semibold text-gray-800">$<span id="live-gold-price">0.00</span>/gram</span></p>
                        <p class="text-gray-600">Nisab: <span class="font-semibold text-gray-800">$<span id="gold-nisab-value">0.00</span></span></p>
                    </div>
                    <div class="absolute top-2 right-2">
                        <div id="gold-check" class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm relative group cursor-pointer nisab-card" onclick="setNisabType('silver')" data-type="silver">
                    <div class="absolute inset-0 border-2 border-transparent rounded-xl transition-all duration-200"></div>
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-gray-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                        </svg>
                        <h4 class="text-lg font-semibold text-gray-800">Silver</h4>
                    </div>
                    <div class="space-y-1 text-center">
                        <p class="text-gray-600">Price: <span class="font-semibold text-gray-800">$<span id="live-silver-price">0.00</span>/gram</span></p>
                        <p class="text-gray-600">Nisab: <span class="font-semibold text-gray-800">$<span id="silver-nisab-value">0.00</span></span></p>
                    </div>
                    <div class="absolute top-2 right-2">
                        <div id="silver-check" class="hidden w-4 h-4 bg-gray-400 rounded-full"></div>
                    </div>
                </div>
            </div>
            <p class="text-sm text-gray-500 text-center mt-4">Click to select Nisab calculation method</p>
            <div class="text-center mt-2">
                <p class="text-sm text-gray-500">Current market prices update every 5 minutes</p>
                <p class="text-xs text-gray-400 mt-1">Last updated: <span id="last-update-time"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const CONSTANTS = {
            GOLD_NISAB_GRAMS: 87.48,
            SILVER_NISAB_GRAMS: 612.36,
            TROY_OUNCE_TO_GRAM: 31.1034768,
            ZAKAT_RATE: 0.025
        };

        // Form configuration
        const formConfig = {
            sections: {
                personalAssets: {
                    id: 'personal-assets',
                    title: 'Personal Assets',
                    defaultChecked: true,
                    fields: {
                        cash: {
                            label: 'Cash & Bank Balances',
                            tooltip: 'Include cash on hand and all bank account balances',
                            groupId: 'cash-group'
                        },
                        preciousMetals: {
                            label: 'Gold & Silver',
                            tooltip: 'Total weight of all gold and silver, including jewelry and coins. Current market prices are used to calculate value.',
                            groupId: 'precious-metals-group',
                            type: 'precious-metals'
                        },
                        investments: {
                            label: 'Investments',
                            tooltip: 'Total market value of stocks, shares, bonds, mutual funds, cryptocurrencies, and other investments, if purchased with the intention of resale.',
                            groupId: 'investments-group'
                        },
                        retirement: {
                            label: 'Retirement Accounts',
                            tooltip: 'Cash value of retirement accounts (IRA, 401k, etc.)',
                            groupId: 'retirement-group'
                        },
                        receivables: {
                            label: 'Receivables',
                            tooltip: 'Loans given to others, expected tax refunds, etc.',
                            groupId: 'receivables-group'
                        }
                    }
                },
                personalLiabilities: {
                    id: 'personal-liabilities',
                    title: 'Personal Liabilities',
                    defaultChecked: true,
                    fields: {
                        personalDebts: {
                            label: 'Personal Debts',
                            tooltip: 'Personal loans owed, credit card debt, etc.',
                            groupId: 'personal-debts-group'
                        },
                        immediateDebts: {
                            label: 'Immediate Debts',
                            tooltip: 'Immediate debts due (rent, utilities, etc.)',
                            groupId: 'immediate-debts-group'
                        },
                        zakatPaid: {
                            label: 'Zakat Paid in Advance',
                            tooltip: 'Any Zakat amount already paid in advance',
                            groupId: 'zakat-paid-group'
                        }
                    }
                },
                businessAssets: {
                    id: 'business-assets',
                    title: 'Business Assets',
                    defaultChecked: false,
                    fields: {
                        businessCash: {
                            label: 'Business Cash & Bank Balances',
                            tooltip: 'Business cash on hand and bank balances',
                            groupId: 'business-cash-group'
                        },
                        inventory: {
                            label: 'Inventory Value',
                            tooltip: 'Net value of business inventory & trade goods',
                            groupId: 'inventory-group'
                        },
                        businessReceivables: {
                            label: 'Business Receivables',
                            tooltip: 'Expected business receivables by Zakat due date',
                            groupId: 'business-receivables-group'
                        }
                    }
                },
                businessLiabilities: {
                    id: 'business-liabilities',
                    title: 'Business Liabilities',
                    defaultChecked: false,
                    fields: {
                        businessLoans: {
                            label: 'Business Loans',
                            tooltip: 'Outstanding business loans and credit',
                            groupId: 'business-loans-group'
                        },
                        accountsPayable: {
                            label: 'Accounts Payable',
                            tooltip: 'Money owed to suppliers and vendors',
                            groupId: 'accounts-payable-group'
                        },
                        wagesPayable: {
                            label: 'Wages & Salaries Payable',
                            tooltip: 'Outstanding wages, salaries, and benefits owed to employees',
                            groupId: 'wages-payable-group'
                        },
                        businessTaxes: {
                            label: 'Business Taxes Due',
                            tooltip: 'Pending business tax payments',
                            groupId: 'business-taxes-group'
                        }
                    }
                }
            }
        };

        // State management
        const state = {
            goldPrice: 0,
            silverPrice: 0,
            nisabType: 'gold',
            lastUpdate: null,
            isCalculating: false,
            
            // Getters
            get nisabThreshold() {
                return this.nisabType === 'gold' 
                    ? CONSTANTS.GOLD_NISAB_GRAMS * this.goldPrice 
                    : CONSTANTS.SILVER_NISAB_GRAMS * this.silverPrice;
            },
            
            // Setters
            setNisabType(type) {
                if (!['gold', 'silver'].includes(type)) {
                    console.error('Invalid nisab type:', type);
                    return;
                }
                this.nisabType = type;
                this.updateUI();
            },
            
            // UI Updates
            updateUI() {
                const goldCheck = document.getElementById('gold-check');
                const silverCheck = document.getElementById('silver-check');
                const goldCard = document.querySelector('[data-type="gold"]');
                const silverCard = document.querySelector('[data-type="silver"]');
                
                if (goldCheck && silverCheck && goldCard && silverCard) {
                    goldCheck.classList.toggle('hidden', this.nisabType !== 'gold');
                    silverCheck.classList.toggle('hidden', this.nisabType !== 'silver');
                    
                    goldCard.querySelector('.border-2').classList.toggle('border-yellow-500', this.nisabType === 'gold');
                    silverCard.querySelector('.border-2').classList.toggle('border-gray-400', this.nisabType === 'silver');
                }
            },
            
            // Price Updates
            async updatePrices() {
                try {
                    // Simulated prices for demo
                    this.goldPrice = 2881.20 / CONSTANTS.TROY_OUNCE_TO_GRAM;
                    this.silverPrice = 33.50 / CONSTANTS.TROY_OUNCE_TO_GRAM;
                    this.lastUpdate = new Date();
                    
                    // Update UI elements
                    const elements = {
                        'live-gold-price': this.goldPrice.toFixed(2),
                        'live-silver-price': this.silverPrice.toFixed(2),
                        'gold-nisab-value': (CONSTANTS.GOLD_NISAB_GRAMS * this.goldPrice).toFixed(2),
                        'silver-nisab-value': (CONSTANTS.SILVER_NISAB_GRAMS * this.silverPrice).toFixed(2),
                        'last-update-time': this.lastUpdate.toLocaleTimeString()
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = value;
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Error updating metal prices:', error);
                    return false;
                }
            }
        };

        // Cookie management
        const CookieManager = {
            setCookie(name, value, days = 365) {
                try {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    const expires = `expires=${date.toUTCString()}`;
                    const cookieValue = encodeURIComponent(JSON.stringify(value));
                    document.cookie = `${name}=${cookieValue};${expires};path=/;SameSite=Strict`;
                } catch (error) {
                    console.error('Error saving cookie:', error);
                }
            },

            getCookie(name) {
                try {
                    const cookieName = `${name}=`;
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.indexOf(cookieName) === 0) {
                            const value = cookie.substring(cookieName.length, cookie.length);
                            return JSON.parse(decodeURIComponent(value));
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('Error reading cookie:', error);
                    return null;
                }
            },

            deleteCookie(name) {
                try {
                    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict`;
                } catch (error) {
                    console.error('Error deleting cookie:', error);
                }
            },

            saveFormState() {
                try {
                    // Don't save if we're not fully initialized
                    if (!window.isFormInitialized) {
                        console.log('Form not fully initialized, skipping save');
                        return;
                    }

                    const formState = {
                        sections: {},
                        nisabType: state.nisabType,
                        lastSaved: new Date().toISOString()
                    };

                    // Save section visibility and field values
                    Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                        const section = document.getElementById(sectionConfig.id);
                        if (!section) {
                            console.warn(`Section ${sectionKey} not found in DOM`);
                            return;
                        }

                        const toggle = section.querySelector('input[type="checkbox"]');
                        if (!toggle) {
                            console.warn(`Toggle not found for section ${sectionKey}`);
                            return;
                        }

                        formState.sections[sectionKey] = {
                            visible: toggle.checked,
                            fields: {}
                        };

                        // Save field values
                        Object.entries(sectionConfig.fields).forEach(([fieldKey, fieldConfig]) => {
                            try {
                                if (fieldConfig.type === 'precious-metals') {
                                    const container = section.querySelector(`#${fieldConfig.groupId} .precious-metals-container`);
                                    if (!container) {
                                        console.warn(`Container not found for ${fieldKey}`);
                                        return;
                                    }

                                    formState.sections[sectionKey].fields[fieldKey] = Array.from(container.children)
                                        .map(row => {
                                            const goldInput = row.querySelector('input[data-group="gold-weight"]');
                                            const silverInput = row.querySelector('input[data-group="silver-weight"]');
                                            return {
                                                gold: goldInput ? (goldInput.dataset.rawValue || goldInput.value.replace(/,/g, '')) : '',
                                                silver: silverInput ? (silverInput.dataset.rawValue || silverInput.value.replace(/,/g, '')) : ''
                                            };
                                        })
                                        .filter(({ gold, silver }) => gold || silver); // Only save non-empty rows
                                } else {
                                    const inputs = document.querySelectorAll(`[data-group="${fieldConfig.groupId}"]`);
                                    formState.sections[sectionKey].fields[fieldKey] = Array.from(inputs)
                                        .map(input => input.dataset.rawValue || input.value.replace(/,/g, ''))
                                        .filter(value => value); // Only save non-empty values
                                }
                            } catch (error) {
                                console.error(`Error saving field ${fieldKey}:`, error);
                            }
                        });
                    });

                    this.setCookie('zakatFormState', formState);
                    console.log('Form state saved successfully');
                } catch (error) {
                    console.error('Error saving form state:', error);
                }
            },

            restoreFormState() {
                try {
                    const formState = this.getCookie('zakatFormState');
                    if (!formState) {
                        console.log('No saved form state found, keeping initial fields');
                        return;
                    }

                    console.log('Restoring form state:', formState);

                    // Validate form state structure
                    if (!formState.sections || typeof formState.sections !== 'object') {
                        throw new Error('Invalid form state structure');
                    }

                    // Restore nisab type
                    if (formState.nisabType) {
                        state.setNisabType(formState.nisabType);
                    }

                    // Restore section visibility and field values
                    Object.entries(formState.sections).forEach(([sectionKey, sectionData]) => {
                        const section = document.getElementById(formConfig.sections[sectionKey]?.id);
                        if (!section) {
                            console.warn(`Section ${sectionKey} not found in DOM`);
                            return;
                        }

                        // Set section visibility
                        const toggle = section.querySelector('input[type="checkbox"]');
                        if (toggle) {
                            toggle.checked = sectionData.visible;
                            const content = section.querySelector(`#${formConfig.sections[sectionKey].id}-section`);
                            if (content) {
                                content.classList.toggle('hidden', !sectionData.visible);
                            }
                        }

                        // Restore field values
                        Object.entries(sectionData.fields || {}).forEach(([fieldKey, values]) => {
                            const fieldConfig = formConfig.sections[sectionKey].fields[fieldKey];
                            if (!fieldConfig) {
                                console.warn(`Field ${fieldKey} not found in config`);
                                return;
                            }

                            const container = section.querySelector(
                                fieldConfig.type === 'precious-metals' 
                                    ? `#${fieldConfig.groupId} .precious-metals-container`
                                    : `#${fieldConfig.groupId} .inputs-container`
                            );

                            if (!container) {
                                console.warn(`Container not found for ${fieldKey}`);
                                return;
                            }

                            // Only clear and restore if we have values to restore
                            if (values && values.length > 0) {
                                container.innerHTML = '';
                                values.forEach(value => {
                                    const field = fieldConfig.type === 'precious-metals'
                                        ? UI.createPreciousMetalsFields()
                                        : UI.createInputField(fieldConfig.groupId);

                                    if (field) {
                                        if (fieldConfig.type === 'precious-metals') {
                                            const goldInput = field.querySelector('input[data-group="gold-weight"]');
                                            const silverInput = field.querySelector('input[data-group="silver-weight"]');
                                            if (goldInput && value.gold) {
                                                goldInput.value = value.gold;
                                                goldInput.dataset.rawValue = value.gold;
                                                UI.setupNumberInput(goldInput);
                                            }
                                            if (silverInput && value.silver) {
                                                silverInput.value = value.silver;
                                                silverInput.dataset.rawValue = value.silver;
                                                UI.setupNumberInput(silverInput);
                                            }
                                        } else {
                                            const input = field.querySelector('input');
                                            if (input && value) {
                                                input.value = value;
                                                input.dataset.rawValue = value;
                                                UI.setupNumberInput(input);
                                            }
                                        }
                                        container.appendChild(field);
                                    }
                                });
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error restoring form state:', error);
                    this.deleteCookie('zakatFormState');
                }
            }
        };

        // UI Components
        const UI = {
            formatNumber(value) {
                if (!value) return '';
                const num = Number(value.replace(/[^\d.]/g, ''));
                return isNaN(num) ? '' : num.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },

            setupNumberInput(input) {
                if (!input) return;
                try {
                    new Cleave(input, {
                        numeral: true,
                        numeralDecimalScale: 2,
                        numeralPositiveOnly: true,
                        prefix: '',
                        delimiter: ',',
                        numeralDecimalMark: '.',
                        onValueChanged: event => {
                            input.dataset.rawValue = event.target.value.replace(/,/g, '');
                        }
                    });
                } catch (error) {
                    console.error('Error setting up number input:', error);
                }
            },

            createButton(type, onClick, className, content) {
                const button = document.createElement('button');
                button.type = type;
                button.className = className;
                button.onclick = onClick;
                button.innerHTML = content;
                return button;
            },

            createInputField(groupId, placeholder = "Enter amount") {
                if (!groupId) return null;
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2 mt-2';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900';
                input.placeholder = placeholder;
                input.dataset.group = groupId;
                
                UI.setupNumberInput(input);
                
                const removeBtn = UI.createButton(
                    'button',
                    () => wrapper.remove(),
                    'text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded',
                    '−'
                );
                
                wrapper.append(input, removeBtn);
                return wrapper;
            },

            createPreciousMetalsFields() {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2';
                
                ['gold', 'silver'].forEach(type => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white';
                    input.placeholder = `${type.charAt(0).toUpperCase() + type.slice(1)} (grams)`;
                    input.dataset.group = `${type}-weight`;
                    UI.setupNumberInput(input);
                    wrapper.appendChild(input);
                });
                
                const removeBtn = UI.createButton(
                    'button',
                    () => wrapper.remove(),
                    'text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded',
                    '−'
                );
                
                wrapper.appendChild(removeBtn);
                return wrapper;
            },

            createLabelWithTooltip(label, tooltip) {
                return `
                    <label class="font-semibold flex items-center">
                        ${label}
                        <div class="relative inline-block ml-2 group">
                            <span class="text-gray-400 group-hover:text-black cursor-pointer">&#9432;</span>
                            <div class="absolute left-0 top-6 bg-gray-800 text-white text-xs rounded p-2 w-48 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                ${tooltip}
                            </div>
                        </div>
                    </label>
                `;
            },

            createSection(sectionId, sectionConfig) {
                const section = document.createElement('div');
                section.id = sectionId;
                section.className = `border rounded-lg p-4 mb-4 ${
                    sectionId.includes('assets') ? 'bg-emerald-50/50' : 
                    sectionId.includes('liabilities') ? 'bg-rose-50/50' : ''
                }`;
                
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-4';
                
                const title = document.createElement('h2');
                title.className = 'text-lg font-semibold';
                title.textContent = sectionConfig.title;
                
                const toggleWrapper = document.createElement('label');
                toggleWrapper.className = 'relative inline-flex items-center cursor-pointer';
                
                const toggle = document.createElement('input');
                toggle.type = 'checkbox';
                toggle.className = 'sr-only peer';
                toggle.checked = sectionConfig.defaultChecked;
                
                const toggleUI = document.createElement('div');
                toggleUI.className = 'w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600';
                
                const content = document.createElement('div');
                content.id = `${sectionId}-section`;
                content.className = 'space-y-4';
                
                if (!sectionConfig.defaultChecked) {
                    content.classList.add('hidden');
                }
                
                toggle.addEventListener('change', () => {
                    content.classList.toggle('hidden', !toggle.checked);
                });
                
                toggleWrapper.append(toggle, toggleUI);
                header.append(title, toggleWrapper);
                section.append(header, content);
                
                return { section, content };
            }
        };

        // Calculation helpers
        const Calculator = {
            getGroupTotal(groupId) {
                if (!groupId) return 0;
                return Array.from(document.querySelectorAll(`[data-group="${groupId}"]`))
                    .reduce((sum, input) => {
                        const value = input.dataset.rawValue || '0';
                        return sum + (Number(value) || 0);
                    }, 0);
            },

            calculateSectionTotals(sectionConfig) {
                return Object.entries(sectionConfig.fields)
                    .map(([_, fieldConfig]) => {
                        let value = 0;
                        if (fieldConfig.type === 'precious-metals') {
                            const goldValue = this.getGroupTotal('gold-weight') * state.goldPrice;
                            const silverValue = this.getGroupTotal('silver-weight') * state.silverPrice;
                            value = goldValue + silverValue;
                        } else {
                            value = this.getGroupTotal(fieldConfig.groupId);
                        }
                        return { label: fieldConfig.label, value };
                    })
                    .filter(({ value }) => value > 0);
            },

            calculateTotalAssets() {
                const goldValue = this.getGroupTotal('gold-weight') * state.goldPrice;
                const silverValue = this.getGroupTotal('silver-weight') * state.silverPrice;
                const otherAssets = Object.entries(formConfig.sections)
                    .filter(([key]) => key.includes('Assets'))
                    .reduce((total, [_, section]) => {
                        return total + Object.values(section.fields)
                            .filter(field => field.type !== 'precious-metals')
                            .reduce((sectionTotal, field) => sectionTotal + this.getGroupTotal(field.groupId), 0);
                    }, 0);
                return goldValue + silverValue + otherAssets;
            },

            calculateTotalLiabilities() {
                return Object.entries(formConfig.sections)
                    .filter(([key]) => key.includes('Liabilities'))
                    .reduce((total, [_, section]) => {
                        return total + Object.values(section.fields)
                            .reduce((sectionTotal, field) => sectionTotal + this.getGroupTotal(field.groupId), 0);
                    }, 0);
            }
        };

        // Main calculation function
        window.calculateZakat = function() {
            if (!state.goldPrice || !state.silverPrice) {
                document.getElementById('result').innerHTML = '<div class="text-red-500">Unable to calculate. Please wait for metal prices to load.</div>';
                return;
            }

            // Save form state before calculating
            CookieManager.saveFormState();

            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            // Generate section rows
            const sectionRows = Object.entries(formConfig.sections)
                .map(([sectionKey, sectionConfig]) => {
                    const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                    const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                    return sectionTotal > 0 ? 
                        `<tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 text-left">${sectionConfig.title}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm font-medium text-gray-900">$${sectionTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </td>
                        </tr>` : '';
                })
                .join('');

            // Generate business section rows if needed
            const hasBusinessSections = Object.values(formConfig.sections).some(section => 
                section.id.includes('business') && 
                document.getElementById(section.id)?.querySelector('input[type="checkbox"]')?.checked
            );

            const businessRows = hasBusinessSections ? 
                `<tr class="border-t border-gray-200">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 text-left">Total Assets</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="text-sm font-medium text-gray-900">$${totalAssets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </td>
                </tr>
                
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 text-left">Total Liabilities</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="text-sm font-medium text-gray-900">$${totalLiabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </td>
                </tr>` : '';

            // Generate action buttons
            const actionButtons = `
                ${isEligible ? 
                    `<button id="pay-link" onclick="window.location.href='https://darulqasim.org/donate-bb/'" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                        Pay Zakat Now
                    </button>` : ''}
                <button onclick="downloadAsExcel()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Excel
                </button>
                <button onclick="downloadAsPDF()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    PDF
                </button>`;

            // Generate final HTML
            const resultHTML = `
                <div class="result-appear space-y-4 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl shadow-sm">
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="w-full">
                            <tbody>
                                ${sectionRows}
                                ${businessRows}
                                <tr class="border-t border-gray-200">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 text-left">Net Wealth</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$${netWealth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 text-left">Zakat Amount Due</div>
                                        ${!isEligible ? '<div class="text-sm text-gray-500 text-left">(Below Nisab threshold)</div>' : ''}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$${zakatAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex flex-wrap justify-center gap-3 mt-4">
                        ${actionButtons}
                    </div>
                </div>`;

            document.getElementById('result').innerHTML = resultHTML;
        };

        // Download functions
        function downloadAsExcel() {
            const workbook = XLSX.utils.book_new();
            const sectionsData = [];
            let currentRow = 0;

            // Add title and date
            sectionsData.push(
                ['Zakat Calculation Report'],
                [`Generated on: ${new Date().toLocaleString()}`],
                []
            );
            currentRow += 3;

            // Add sections with pre-calculated values
            Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                if (sectionTotals.length === 0) return;

                sectionsData.push([sectionConfig.title]);
                currentRow++;

                sectionTotals.forEach(({ label, value }) => {
                    sectionsData.push(['', label, value]);
                    currentRow++;
                });

                const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                sectionsData.push(['', 'Total', sectionTotal]);
                currentRow++;
                sectionsData.push([]);
                currentRow++;
            });

            // Add summary section with pre-calculated values
            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            sectionsData.push(
                ['Summary'],
                ['', 'Total Assets', totalAssets],
                ['', 'Total Liabilities', totalLiabilities],
                ['', 'Net Wealth', netWealth]
            );
            currentRow += 4;

            // Add Zakat section with pre-calculated values
            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            sectionsData.push(
                ['Zakat Status'],
                ['', 'Zakat Amount Due', zakatAmount]
            );

            // Create and format worksheet
            const sectionsSheet = XLSX.utils.aoa_to_sheet(sectionsData);
            sectionsSheet['!cols'] = [{ wch: 20 }, { wch: 40 }, { wch: 15 }];

            // Set cell types and formats
            for (let R = 0; R < sectionsData.length; R++) {
                for (let C = 0; C < sectionsData[R].length; C++) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (C === 2 && R > 2) {
                        const value = sectionsData[R][C];
                        sectionsSheet[cell_ref] = {
                            t: 'n',
                            v: value,
                            z: '#,##0.00'
                        };
                    }
                }
            }

            XLSX.utils.book_append_sheet(workbook, sectionsSheet, 'Zakat Calculation');
            XLSX.writeFile(workbook, 'zakat_calculation.xlsx');
        }

        function downloadAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            // Add title and date
            doc.setFontSize(20);
            doc.text('Zakat Calculation Report', 20, y);
            y += 20;

            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, y);
            y += 15;

            // Add sections
            Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                if (sectionTotal === 0) return;

                doc.setFontSize(14);
                doc.text(sectionConfig.title, 20, y);
                y += 10;

                doc.setFontSize(12);
                sectionTotals.forEach(({ label, value }) => {
                    doc.text(label, 30, y);
                    doc.text(`$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                    y += 8;
                });

                doc.text('Total', 30, y);
                doc.text(`$${sectionTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 15;
            });

            // Add summary
            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            doc.setFontSize(14);
            doc.text('Summary', 20, y);
            y += 10;

            doc.setFontSize(12);
            if (totalAssets > 0) {
                doc.text('Total Assets', 30, y);
                doc.text(`$${totalAssets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 8;
            }

            if (totalLiabilities > 0) {
                doc.text('Total Liabilities', 30, y);
                doc.text(`$${totalLiabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 8;
            }

            doc.text('Net Wealth', 30, y);
            doc.text(`$${netWealth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
            y += 15;

            // Add Zakat amount
            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            doc.setFontSize(14);
            if (isEligible) {
                doc.text('Zakat Amount Due', 20, y);
                y += 10;
                doc.setFontSize(16);
                doc.text(`$${zakatAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
            } else {
                doc.text('Zakat Status', 20, y);
                y += 10;
                doc.setFontSize(12);
                doc.text('Not eligible - Wealth below Nisab threshold', 30, y);
            }

            doc.save('zakat_calculation.pdf');
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize core functionality
            setNisabType('gold');
            state.updatePrices();
            setInterval(state.updatePrices, 300000); // Update every 5 minutes
            
            // Initialize form
            const form = document.getElementById('zakat-form');
            if (!form) return;
            
            // Clear existing content
            form.innerHTML = '';
            
            // Create all sections
            Object.entries(formConfig.sections).forEach(([_, sectionConfig]) => {
                const { section, content } = UI.createSection(sectionConfig.id, sectionConfig);
                
                // Create fields for each section
                Object.entries(sectionConfig.fields).forEach(([_, fieldConfig]) => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.id = fieldConfig.groupId;
                    fieldDiv.className = 'mb-4';
                    
                    const labelContainer = document.createElement('div');
                    labelContainer.className = 'flex items-center justify-between mb-2';
                    labelContainer.innerHTML = UI.createLabelWithTooltip(fieldConfig.label, fieldConfig.tooltip);
                    
                    const addButton = UI.createButton(
                        'button',
                        () => {
                            const newField = fieldConfig.type === 'precious-metals' 
                                ? UI.createPreciousMetalsFields() 
                                : UI.createInputField(fieldConfig.groupId);
                            container.appendChild(newField);
                        },
                        'text-green-500 hover:text-green-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none',
                        '+'
                    );
                    
                    labelContainer.appendChild(addButton);
                    
                    const container = document.createElement('div');
                    container.className = fieldConfig.type === 'precious-metals' 
                        ? 'precious-metals-container space-y-2' 
                        : 'inputs-container space-y-2';
                    
                    const initialField = fieldConfig.type === 'precious-metals'
                        ? UI.createPreciousMetalsFields()
                        : UI.createInputField(fieldConfig.groupId);
                    
                    if (initialField) {
                        container.appendChild(initialField);
                    }
                    
                    fieldDiv.appendChild(labelContainer);
                    fieldDiv.appendChild(container);
                    content.appendChild(fieldDiv);
                });
                
                form.appendChild(section);
            });
            
            // Add calculate button
            const calculateButton = UI.createButton(
                'button',
                window.calculateZakat,
                'w-full bg-blue-500 text-white p-2 rounded font-semibold hover:bg-blue-600 mt-4',
                'Calculate'
            );
            calculateButton.id = 'calculate-button';
            form.appendChild(calculateButton);
            
            // Set form as initialized
            window.isFormInitialized = true;
            
            // Wait a brief moment before restoring state to ensure DOM is ready
            setTimeout(() => {
                CookieManager.restoreFormState();
            }, 100);
            
            // Debounced form state saving
            const debounce = (fn, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn(...args), delay);
                };
            };

            const debouncedSave = debounce(() => {
                if (window.isFormInitialized) {
                    CookieManager.saveFormState();
                }
            }, 1000);

            // Event listeners
            document.addEventListener('input', e => {
                if (e.target.matches('input[type="text"]')) {
                    debouncedSave();
                }
            });

            document.addEventListener('change', e => {
                if (e.target.matches('input[type="checkbox"]')) {
                    debouncedSave();
                }
            });
        });

        function setNisabType(type) {
            if (!['gold', 'silver'].includes(type)) return;
            
            const elements = {
                gold: {
                    check: document.getElementById('gold-check'),
                    card: document.querySelector('[data-type="gold"]')
                },
                silver: {
                    check: document.getElementById('silver-check'),
                    card: document.querySelector('[data-type="silver"]')
                }
            };
            
            Object.entries(elements).forEach(([metal, { check, card }]) => {
                check.classList.toggle('hidden', metal !== type);
                card.querySelector('.border-2').classList.toggle(
                    metal === 'gold' ? 'border-yellow-500' : 'border-gray-400',
                    metal === type
                );
            });
            
            window.selectedNisabType = type;
            if (document.getElementById('result').innerHTML) {
                window.calculateZakat();
            }
        }
    </script>
</body>
</html>
