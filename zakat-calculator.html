<!--
TODO:
   - currencies 
   - madhhabs
   - FAQ 
   
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zakat Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
    <style>
        /* Remove up/down arrows from number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Result message animations */
        .result-appear {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Settings panel animations */
        .settings-panel {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .settings-panel.open {
            transform: translateX(0);
        }

        /* Overlay animation */
        .settings-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container mx-auto flex flex-col lg:flex-row gap-4 items-start justify-center">
        <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md relative">
            <h1 class="text-2xl font-bold text-center mb-4">Zakat Calculator</h1>
            
            <!-- Settings Icon -->
            <button id="settings-toggle" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>

            <!-- FAQ Icon -->
            <button id="faq-toggle" class="absolute top-6 right-16 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </button>

            <form id="zakat-form" class="space-y-6">
                <button type="button" id="calculate-button" class="w-full bg-blue-500 text-white p-2 rounded font-semibold hover:bg-blue-600">Calculate</button>
            </form>

            <div id="result" class="mt-4 text-center text-lg font-semibold"></div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-overlay" class="settings-overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div>
        <div id="settings-panel" class="settings-panel fixed top-0 right-0 h-full w-96 bg-white shadow-xl z-50 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Settings</h2>
                    <button id="settings-close" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Nisab Type Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Nisab Type</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white rounded-xl p-4 shadow-sm relative group cursor-pointer nisab-card" onclick="setNisabType('gold')" data-type="gold">
                            <div class="absolute inset-0 border-2 border-transparent rounded-xl transition-all duration-200"></div>
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-800">Gold</h4>
                            </div>
                            <div class="space-y-1 text-center">
                                <p class="text-gray-600">Price: <span class="font-semibold text-gray-800">$<span id="live-gold-price">0.00</span>/gram</span></p>
                                <p class="text-gray-600">Nisab: <span class="font-semibold text-gray-800">$<span id="gold-nisab-value">0.00</span></span></p>
                            </div>
                            <div class="absolute top-2 right-2">
                                <div id="gold-check" class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm relative group cursor-pointer nisab-card" onclick="setNisabType('silver')" data-type="silver">
                            <div class="absolute inset-0 border-2 border-transparent rounded-xl transition-all duration-200"></div>
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-gray-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                                <h4 class="text-lg font-semibold text-gray-800">Silver</h4>
                            </div>
                            <div class="space-y-1 text-center">
                                <p class="text-gray-600">Price: <span class="font-semibold text-gray-800">$<span id="live-silver-price">0.00</span>/gram</span></p>
                                <p class="text-gray-600">Nisab: <span class="font-semibold text-gray-800">$<span id="silver-nisab-value">0.00</span></span></p>
                            </div>
                            <div class="absolute top-2 right-2">
                                <div id="silver-check" class="hidden w-4 h-4 bg-gray-400 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 text-center mt-4">Click to select Nisab calculation method. See FAQ for details.</p>
                    <div class="text-center mt-2">
                        <p class="text-sm text-gray-500">Current market prices update every 5 minutes</p>
                        <p class="text-xs text-gray-400 mt-1">Last updated: <span id="last-update-time"></span></p>
                    </div>
                </div>

                <!-- Label Settings Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Label Settings</h3>
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-base font-medium text-gray-800">Enable Custom Labels</h4>
                                <p class="text-sm text-gray-500">Add labels for each input field. For example, you can label your cash as "Checking Account", "Cash (physical)", etc.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="enable-labels" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ Panel -->
        <div id="faq-overlay" class="settings-overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div>
        <div id="faq-panel" class="settings-panel fixed top-0 right-0 h-full w-96 bg-white shadow-xl z-50 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Frequently Asked Questions</h2>
                    <button id="faq-close" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="faq-container"></div>
            </div>
        </div>
    </div>

    <!-- Autosave Indicator -->
    <div id="autosave-indicator" class="fixed bottom-4 right-4 flex items-center gap-1.5 text-sm bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-full shadow-sm border border-gray-200/50 transition-all duration-300 opacity-0 pointer-events-none">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span class="text-xs font-medium">Saved</span>
    </div>

    <script>
        // FAQ Data
        const faqData = {
            "general": {
                "title": "General Questions",
                "questions": [
                    {
                        "question": "When does Zakat become obligatory on me?",
                        "answer": "In brief, zakat - 2.5% of ones zakatable wealth - becomes obligatory to give once a Muslim adult - man or woman -  possesses the niṣāb (zakat threshold) amount of  zakatable wealth for one lunar year in excess of his essential belongings and debts."
                    },
                    {
                        "question": "How much is Zakat?",
                        "answer": "Zakat is 2.5% of one's zakatable wealth."
                    },
                    {
                        "question": "What is \"niṣāb\"?",
                        "answer": "The niṣāb (zakat threshold) is calculated at about 87.482 grams of gold (≈$8,100 as of March, 2025) or 612.35 grams of silver (≈$660 as of March, 2025). Once an individual possesses zakatable wealth equivalent to this amount, he will be obligated to pay zakat: 2.5% on the total zakatable amount. It is the position of Darul Ifta, Darul Qasim that either niṣāb may be used in our context."
                    },
                    {
                        "question": "What is \"zakatable\" wealth?",
                        "answer": "Zakat is only due on zakatable assets:\nA.   fiat and crypto currencies\nB.    Gold and silver in any form\nC.    Business inventory and financial investments such as stocks and vested 401k. \nGenerally, any other type of wealth does not obligate zakat. For example, paintings, decorative plants, board games, etc."
                    },
                    {
                        "question": "Do I have to give zakat on my \"essential belongings\"?",
                        "answer": "\"Essential belongings\" are not included in zakat. \"Essential belongings\" include all essential items such as residence, vehicles, furniture, appliances, and all tools and instruments relating to one's profession. So, one will not include the value of his home, furniture, cars etc. when calculating his zakatable wealth."
                    },
                    {
                        "question": "Do I have to give zakat on debts?",
                        "answer": "Short term debts are subtracted from one's zakatable assets. Short term debts include all debts to be paid within a given year. Long term debts such as mortgages and car payments will not be subtracted from one's zakatable assets except for  the amount of debt due for a single year. For example, Zayd has a mortgage of $300,000 to be paid over thirty years, with $10,000 being due each year. When calculating his zakat, Zayd will subtract the amount he owes for the year, i.e., $10,000, not the entire amount of the mortgage, i.e., $300,000."
                    },
                    {
                        "question": "Will I subtract future expenses from my Zakat?",
                        "answer": "Only expenses already incurred will be subtracted. Future expenses will not be subtracted. For example, Zayd has already spent $1,000 on gas and anticipates he will spend another $200 in the next two months. He will not subtract an additional $200 from his zakat."
                    },
                    {
                        "question": "How long do I have to possess the wealth before zakat becomes obligatory?",
                        "answer": "The wealth must be owned at the beginning and end of one Islamic year (regardless of the exact start date). If the wealth fluctuates, even to below the niṣāb, zakat will be obligatory so long as the niṣāb is maintained at the start and end of the yearly-cycle. If the wealth is completely lost at any point before the completion of the year, then the year will restart only after the niṣāb is met again.\n\nFor example, Zayd reaches niṣāb on Ramaḍān 1st. As long as he has the niṣāb on the last day of Shaʿbān the following year (i.e., one Islamic year), he will be obligated to give zakat – even if his wealth dropped to less than the niṣāb throughout the year. It is only in the case Zayd becomes bankrupt that he will disregard his previous niṣāb date (Ramaḍān 1st, in this case) altogether."
                    },
                    {
                        "question": "When is it obligatory on me to give zakat?",
                        "answer": "Zakat should be given as soon as possible, within one year of becoming obligatory. Delaying zakat without a valid excuse for multiple years incurs sin, and the obligation to pay for all previous years remains. It is permissible to give zakat in Ramadan, whether before or after the due date of one's annual zakat. However, if a person passes away after zakat becomes obligatory, it must be settled from ⅓ of their estate if bequeathed. Additionally, if the actual zakat amount due exceeds the initial estimate, the difference must be paid."
                    },
                    {
                        "question": "Can I just estimate how much zakat is due on me?",
                        "answer": "One must be diligent in calculating their zakat and cannot afford to miss even a dollar's amount. Overestimating is allowed."
                    }
                ]
            },
            "goldAndSilver": {
                "title": "Gold, Silver, and Jewelry",
                "questions": [
                    {
                        "question": "Is there zakat on gold and silver in non-jewelry form (bars, cutlery, raw form, etc.)?",
                        "answer": "Zakat is due on gold and silver in any form including bars and cutlery."
                    },
                    {
                        "question": "Is there zakat on jewelry?",
                        "answer": "Zakat is due on gold and silver jewelry only."
                    },
                    {
                        "question": "Is there zakat for non-gold and non-silver jewelry?",
                        "answer": "Zakat is not due on non-gold and non-silver jewelry"
                    },
                    {
                        "question": "Is there zakat on gold and silver jewelry that I do not wear/use?",
                        "answer": "Zakat is due on gold and silver regardless of whether it is worn or not."
                    },
                    {
                        "question": "How many karats qualify jewelry for zakat?",
                        "answer": "For zakat calculation purposes, all gold/silver items which are 12 karat and higher are treated as pure gold/silver. If the purity of your gold/silver is at least 12 karat, zakat will be discharged on the total weight of the jewelry; this will not be considered 'overpaying.' If the price of gold is -for example- $75/gram, and you have gold jewelry (12k or higher) weighing a total of 100 grams, you will discharge 2.5% of $7,500: $187.5.\n\nIf the gold and silver form less than half of the item: if they are removable – even by melting – then zakat is obligatory, but only on the amount of gold or silver. If they are not removable, then there is no obligation to pay zakat. There is no zakat on non-gold and non-silver jewelry whatsoever."
                    }
                ]
            },
            "business": {
                "title": "Business",
                "questions": [
                    {
                        "question": "Do I give zakat on my business inventory? If so, what do I base the amount on?",
                        "answer": "One will pay zakat based upon the selling market price regardless of how high or low it is. Keep in mind that if you sell the item before your zakat year, you will only need to pay zakat on the liquid money you earned."
                    },
                    {
                        "question": "I initially bought something with the intention of selling it, but now I no longer wish to sell it. Am I obligated to give zakat for it?",
                        "answer": "If one initially purchases an item with the intention of selling it, but then changes their intention later on, they are not obligated to give zakat for that item."
                    },
                    {
                        "question": "I initially bought an item with the intention of keeping but now wish to sell it. Am I obligated to give zakat on it?",
                        "answer": "If one initially purchases an item with the intention of keeping it, but then changes their intention later on, they are not obligated to give zakat for that item until they put it on the market."
                    },
                    {
                        "question": "I bought something, such as real estate, with the intention of keeping it for some time but also with the intention of definitely selling it either in the future if I am offered a good deal. Do I have to give zakat on this?",
                        "answer": "If one buys something with the definitive intention of selling it – despite keeping it for the time being - and the possible option of keeping it, they are obligated to give zakat."
                    },
                    {
                        "question": "I bought something, such as real estate, with the intention of keeping it for some time but also with the intention of perhaps selling it in the future if I am offered a good deal. Do I have to give zakat on this?",
                        "answer": "If one buys something with the definitive intention of keeping it and the possible option of selling it, they are not obligated to give zakat."
                    }
                ]
            },
            "investments": {
                "title": "Investments",
                "questions": [
                    {
                        "question": "Do I give zakat for cryptocurrency?",
                        "answer": "One must give zakat on cryptocurrency just as he would for any other currency."
                    },
                    {
                        "question": "Do I give zakat on for my real estate business?",
                        "answer": "For investing in real estate: determine whether it is property for sale or if it will be rented out. If it is for sale you will pay zakat 2.5% of your share based upon the selling market price. After it is sold, you do not need to pay zakat on the money you earned until your next zakat year. If it is a rental property, you will only pay zakat 2.5% on the rental income, not the selling market price of the house."
                    },
                    {
                        "question": "Do I give zakat on stocks?",
                        "answer": "One will pay zakat upon the zakatable value of the stock. You may determine this by contacting the company and checking their balance sheets. For example, a stock may be valued at $100, but $80 of the stock equates to the value of the machinery and other non-zakatable assets. In this case, you will only have to pay zakat on the $20. In any case, if you choose to give zakat for the full $100, your zakat will be more than fulfilled."
                    },
                    {
                        "question": "Do I give zakat on my 401k?",
                        "answer": "One must pay zakat on 401k funds on a yearly basis.\n\nOne may choose to pay before or after withdrawal. If you choose to pay after withdrawal, you must make sure to pay for the previous years also. Taxes will be deducted when calculating zakat on one's 401k portfolio. Not because one does not own the full amount, but because liabilities are deducted. Early withdrawal fees will not be accounted for; unless one withdraws early."
                    },
                    {
                        "question": "Do I give zakat on my pension fund?",
                        "answer": "Pension funds to which the employee did not contribute nor holds access to are not included in zakat calculations until actual withdrawal."
                    }
                ]
            },
            "recipients": {
                "title": "Zakat Recipients",
                "questions": [
                    {
                        "question": "To whom can I give my zakat?",
                        "answer": "Generally, you will give zakat to someone who is \"poor\" - an individual is deemed eligible to receive zakat if they possess neither monetary assets nor items (excluding those essential for personal need) amounting to or exceeding the nisāb threshold. Essential personal use items include, but are not limited to, residence, vehicle, attire, cellular device, computer, appliances, furniture, and similar items. Items of entertainment, such as television sets and video games, are not considered essential items.\n\nPotential \"poor\" people could include:\n\n1.     Students who are below niṣāb\n2.     Family members (excluding direct ascendants and descendants) who are below niṣāb\n3.     Orphans and widows below niṣāb\n4.     Those in debt whose debt causes them to be below niṣāb"
                    },
                    {
                        "question": "Can I give zakat to my family members?",
                        "answer": "It is preferred to give zakat to one's \"extended\" family such as siblings, uncles, cousins etc, It is important to remember that zakat cannot be given to one's direct ascendants and descendants: parents, grandparents and so on, children, and grandchildren and so on."
                    },
                    {
                        "question": "Can I give zakat to construct a masjid, school, hospital, or water well?",
                        "answer": "Zakat must be transferred to a human recipient. An organization or a physical structure cannot receive zakat."
                    }
                ]
            },
            "payingZakat": {
                "title": "Paying Zakat",
                "questions": [
                    {
                        "question": "Can I give my Zakat early?",
                        "answer": "One may discharge their zakat early. That being said, if the total amount they are obligated to pay happens to be higher by the time their zakat date comes around (they receive a higher than expected return or they receive an unexpected bonus for example), they will have to make up the difference. On the other hand, If the total amount turns out to be less and they ended up having paid more than what was due, the excess will count towards next year's zakat."
                    },
                    {
                        "question": "Is there a limit to how much I can give to a single recipient?",
                        "answer": "It is disliked (makrūh) to distribute zakat in such a large amount that the recipients themselves would reach the nisāb threshold, and thus become liable to pay zakat. However, if an individual possesses the niṣāb amount, but has outstanding debts, their possession of this amount does not automatically qualify them as having wealth equivalent to the niṣāb. In all cases, if zakat is given to an individual and upon taking possession, their total wealth is equal to or more than the niṣāb, they can no longer accept zakat."
                    },
                    {
                        "question": "To what extent must I investigate a potential recipient?",
                        "answer": "When determining a zakat recipient's eligibility, one may suffice with apparent markers of need. For example, if an individual has many dependents, a low-income job, and inexpensive commodities, they may be eligible for receiving zakat."
                    },
                    {
                        "question": "I gave zakat to someone thinking that they were poor, but I later learnt that they were not. Is my Zakat fulfilled?",
                        "answer": "If one gave zakat to an individual due to apparent signs of need but then later discovers that their recipient is not zakat-eligible, their obligation is nonetheless fulfilled. However, one must make sure that they give zakat after having knowledge of some markers of need: zakat will not be fulfilled if it is given haphazardly (unless the recipient is, in actuality, zakat-eligible)."
                    },
                    {
                        "question": "Can I give zakat in non-monetary form? For example, can I give clothes in zakat?",
                        "answer": "Zakat may be given in either cash or kind. You will consider the average selling price of the item you wish to give. For example, if you must pay $100 dollars in zakat and the selling price of the clothing you wish to give in zakat is $100, this would be permissible and would fulfil your obligation."
                    },
                    {
                        "question": "Can a relative of mine such as parent or spouse fulfill the obligation of zakat on my behalf?",
                        "answer": "Your parent or spouse may fulfill the obligation of zakat on your behalf, but they are not obligated to. If they do choose to give your zakat on your behalf, make sure to verbally authorize them as your zakat agent."
                    }
                ]
            },
            "sadaqatAlFitr": {
                "title": "Ṣadaqat al-Fiṭr",
                "questions": [
                    {
                        "question": "When does ṣadaqat al-fiṭr become obligatory upon me?",
                        "answer": "Sadaqat al-fiṭr is obligatory upon anyone who possesses the niṣāb amount of wealth beyond their needs even if it consists of non-money property. For example, someone owns – beyond their needs – paintings and decorative items, for example, whose total value exceeds the niṣāb. Although such a person does not have to give zakat, they must give ṣadaqat al-fiṭr and sacrifice an animal on ʿĪd al-Aḍḥā, and cannot receive zakat."
                    },
                    {
                        "question": "When do I have to pay Ṣadaqat al-Fiṭr?",
                        "answer": "Ṣadaqat al-Fiṭr must be given before ʿĪd salah. Generally, it is better to have paid as early as possible so that the poor may use it for their ʿĪd preparations. If it is delayed the ʿĪd salah, it must still be given."
                    },
                    {
                        "question": "Do I have to give Ṣadaqat al-Fiṭr for my children? What about my spouse?",
                        "answer": "One is obligated to give ṣadaqat al-fiṭr on behalf of themselves and their minor children only. One may choose to give ṣadaqat al-fiṭr on behalf of their spouse and major children with their consent/authorization."
                    },
                    {
                        "question": "How much is Ṣadaqat al-Fiṭr?",
                        "answer": "Ṣadaqat al-fiṭr in the Chicagoland area this year is ~$7."
                    }
                ]
            }
        };

        // Constants
        const CONSTANTS = {
            GOLD_NISAB_GRAMS: 87.48,
            SILVER_NISAB_GRAMS: 612.36,
            TROY_OUNCE_TO_GRAM: 31.1034768,
            ZAKAT_RATE: 0.025
        };

        // Form configuration
        const formConfig = {
            sections: {
                personalAssets: {
                    id: 'personal-assets',
                    title: 'Personal Assets',
                    defaultChecked: true,
                    fields: {
                        cash: {
                            label: 'Cash & Bank Balances',
                            tooltip: 'Include cash on hand and all bank account balances',
                            groupId: 'cash-group'
                        },
                        preciousMetals: {
                            label: 'Gold & Silver',
                            tooltip: 'Total weight of all gold and silver, including jewelry and coins. Current market prices are used to calculate value.',
                            groupId: 'precious-metals-group',
                            type: 'precious-metals'
                        },
                        cryptocurrency: {
                            label: 'Cryptocurrency',
                            tooltip: 'Total value of cryptocurrencies held, such as BTC, ETH, XRP, etc.',
                            groupId: 'cryptocurrency-group',
                        },
                        investments: {
                            label: 'Investments',
                            tooltip: 'Zakatable value (see FAQs) of stocks, shares, bonds, mutual funds, and other investments, if purchased with the intention of resale.',
                            groupId: 'investments-group'
                        },
                        retirement: {
                            label: 'Retirement Accounts',
                            tooltip: 'Zakatable value (see FAQs) of retirement accounts (IRA, 401k, etc.)',
                            groupId: 'retirement-group'
                        },
                        receivables: {
                            label: 'Receivables',
                            tooltip: 'Loans given to others, expected payment for sales, etc.',
                            groupId: 'receivables-group'
                        }
                    }
                },
                personalLiabilities: {
                    id: 'personal-liabilities',
                    title: 'Personal Liabilities',
                    defaultChecked: true,
                    fields: {
                        personalDebts: {
                            label: 'Personal Debts',
                            tooltip: 'Personal loans owed, credit card debt, etc.',
                            groupId: 'personal-debts-group'
                        },
                        immediateDebts: {
                            label: 'Immediate Debts',
                            tooltip: 'Immediate debts due (rent, utilities, etc.)',
                            groupId: 'immediate-debts-group'
                        },
                        zakatPaid: {
                            label: 'Zakat Paid in Advance',
                            tooltip: 'Any Zakat amount already paid in advance',
                            groupId: 'zakat-paid-group'
                        }
                    }
                },
                businessAssets: {
                    id: 'business-assets',
                    title: 'Business Assets',
                    defaultChecked: false,
                    fields: {
                        businessCash: {
                            label: 'Business Cash & Bank Balances',
                            tooltip: 'Business cash on hand and bank balances',
                            groupId: 'business-cash-group'
                        },
                        inventory: {
                            label: 'Inventory Value',
                            tooltip: 'Net value of business inventory & trade goods',
                            groupId: 'inventory-group'
                        },
                        businessReceivables: {
                            label: 'Business Receivables',
                            tooltip: 'Expected business receivables by Zakat due date',
                            groupId: 'business-receivables-group'
                        }
                    }
                },
                businessLiabilities: {
                    id: 'business-liabilities',
                    title: 'Business Liabilities',
                    defaultChecked: false,
                    fields: {
                        businessLoans: {
                            label: 'Business Loans',
                            tooltip: 'Outstanding business loans and credit',
                            groupId: 'business-loans-group'
                        },
                        accountsPayable: {
                            label: 'Accounts Payable',
                            tooltip: 'Money owed to suppliers and vendors',
                            groupId: 'accounts-payable-group'
                        },
                        wagesPayable: {
                            label: 'Wages & Salaries Payable',
                            tooltip: 'Outstanding wages, salaries, and benefits owed to employees',
                            groupId: 'wages-payable-group'
                        },
                        businessTaxes: {
                            label: 'Business Taxes Due',
                            tooltip: 'Pending business tax payments',
                            groupId: 'business-taxes-group'
                        }
                    }
                }
            }
        };

        // State management
        const state = {
            goldPrice: 0,
            silverPrice: 0,
            nisabType: 'gold',
            lastUpdate: null,
            isCalculating: false,
            enableLabels: false,
            
            // Getters
            get nisabThreshold() {
                return this.nisabType === 'gold' 
                    ? CONSTANTS.GOLD_NISAB_GRAMS * this.goldPrice 
                    : CONSTANTS.SILVER_NISAB_GRAMS * this.silverPrice;
            },
            
            // Setters
            setNisabType(type) {
                if (!['gold', 'silver'].includes(type)) {
                    console.error('Invalid nisab type:', type);
                    return;
                }
                this.nisabType = type;
                this.updateUI();
            },

            setEnableLabels(enabled) {
                this.enableLabels = enabled;
                this.updateInputLabels();
            },
            
            // UI Updates
            updateUI() {
                const goldCheck = document.getElementById('gold-check');
                const silverCheck = document.getElementById('silver-check');
                const goldCard = document.querySelector('[data-type="gold"]');
                const silverCard = document.querySelector('[data-type="silver"]');
                
                if (goldCheck && silverCheck && goldCard && silverCard) {
                    goldCheck.classList.toggle('hidden', this.nisabType !== 'gold');
                    silverCheck.classList.toggle('hidden', this.nisabType !== 'silver');
                    
                    goldCard.querySelector('.border-2').classList.toggle('border-yellow-500', this.nisabType === 'gold');
                    silverCard.querySelector('.border-2').classList.toggle('border-gray-400', this.nisabType === 'silver');
                }
            },

            updateInputLabels() {
                const inputs = document.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    const wrapper = input.closest('.flex');
                    if (!wrapper) return;

                    if (!input.classList.contains('label-input')) {
                        // Remove any existing width classes
                        input.className = input.className
                            .split(' ')
                            .filter(cls => !cls.startsWith('w-'))
                            .join(' ');
                        // Add appropriate width class
                        input.className += this.enableLabels ? ' w-1/2' : ' w-full';

                        // Handle label input
                        let labelInput = wrapper.querySelector('.label-input');
                        if (this.enableLabels) {
                            if (!labelInput) {
                                labelInput = document.createElement('input');
                                labelInput.type = 'text';
                                labelInput.className = 'label-input w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900';
                                labelInput.placeholder = 'Label';
                                labelInput.dataset.group = input.dataset.group;
                                
                                // Restore previous label value if it exists
                                if (input.dataset.labelValue) {
                                    labelInput.value = input.dataset.labelValue;
                                }
                                
                                wrapper.insertBefore(labelInput, input);
                            }
                        } else {
                            if (labelInput) {
                                // Store the label value before removing
                                input.dataset.labelValue = labelInput.value;
                                labelInput.remove();
                            }
                        }
                    }

                    // Handle precious metals container if this is part of one
                    const metalsContainer = wrapper.querySelector('.flex.gap-2');
                    if (metalsContainer) {
                        metalsContainer.className = metalsContainer.className
                            .split(' ')
                            .filter(cls => !cls.startsWith('w-'))
                            .join(' ');
                        metalsContainer.className += this.enableLabels ? ' w-1/2' : ' w-full';
                    }
                });
            },
            
            // Price Updates
            async updatePrices() {
                try {
                    // Hardcoded fallback prices (in USD per troy ounce)
                    const fallbackPrices = {
                        gold: 94.11,
                        silver: 1.05
                    };

                    // Try to fetch current metal prices from API
                    try {
                        const response = await fetch('https://sry7n4xfeupzzgm6gxj24skff40pgyuj.lambda-url.us-east-2.on.aws');
                        const data = await response.json();
                        
                        // Convert gold price from USD/troy oz to USD/gram
                        this.goldPrice = data.gold_avg_price / CONSTANTS.TROY_OUNCE_TO_GRAM;
                        this.silverPrice = data.silver_avg_price / CONSTANTS.TROY_OUNCE_TO_GRAM;
                    } catch (apiError) {
                        console.warn('Failed to fetch metal prices from API, using fallback values:', apiError);
                        // Use fallback prices
                        this.goldPrice = fallbackPrices.gold;
                        this.silverPrice = fallbackPrices.silver;
                    }

                    this.lastUpdate = new Date();
                    
                    // Update UI elements
                    const elements = {
                        'live-gold-price': this.goldPrice.toFixed(2),
                        'live-silver-price': this.silverPrice.toFixed(2),
                        'gold-nisab-value': (CONSTANTS.GOLD_NISAB_GRAMS * this.goldPrice).toFixed(2),
                        'silver-nisab-value': (CONSTANTS.SILVER_NISAB_GRAMS * this.silverPrice).toFixed(2),
                        'last-update-time': this.lastUpdate.toLocaleTimeString()
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = value;
                    });
                    
                    return true;
                } catch (error) {
                    console.error('Error updating metal prices:', error);
                    return false;
                }
            }
        };

        // Cookie management
        const CookieManager = {
            setCookie(name, value, days = 365) {
                try {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    const expires = `expires=${date.toUTCString()}`;
                    const cookieValue = encodeURIComponent(JSON.stringify(value));
                    document.cookie = `${name}=${cookieValue};${expires};path=/;SameSite=Strict`;
                } catch (error) {
                    console.error('Error saving cookie:', error);
                }
            },

            getCookie(name) {
                try {
                    const cookieName = `${name}=`;
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.indexOf(cookieName) === 0) {
                            const value = cookie.substring(cookieName.length, cookie.length);
                            return JSON.parse(decodeURIComponent(value));
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('Error reading cookie:', error);
                    return null;
                }
            },

            deleteCookie(name) {
                try {
                    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict`;
                } catch (error) {
                    console.error('Error deleting cookie:', error);
                }
            },

            saveFormState() {
                try {
                    // Don't save if we're not fully initialized
                    if (!window.isFormInitialized) {
                        console.log('Form not fully initialized, skipping save');
                        return;
                    }

                    const indicator = document.getElementById('autosave-indicator');
                    if (indicator) {
                        // Show indicator and update state
                        indicator.style.opacity = '1';
                        indicator.classList.remove('text-green-500', 'text-gray-500', 'text-red-500');
                        indicator.classList.add('text-blue-500');
                        indicator.querySelector('span').textContent = 'Saving...';
                    }

                    const formState = {
                        sections: {},
                        nisabType: state.nisabType,
                        enableLabels: state.enableLabels,
                        lastSaved: new Date().toISOString()
                    };

                    // Save section visibility and field values
                    Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                        const section = document.getElementById(sectionConfig.id);
                        if (!section) {
                            console.warn(`Section ${sectionKey} not found in DOM`);
                            return;
                        }

                        const toggle = section.querySelector('input[type="checkbox"]');
                        if (!toggle) {
                            console.warn(`Toggle not found for section ${sectionKey}`);
                            return;
                        }

                        formState.sections[sectionKey] = {
                            visible: toggle.checked,
                            fields: {}
                        };

                        // Save field values
                        Object.entries(sectionConfig.fields).forEach(([fieldKey, fieldConfig]) => {
                            try {
                                if (fieldConfig.type === 'precious-metals') {
                                    const container = section.querySelector(`#${fieldConfig.groupId} .precious-metals-container`);
                                    if (!container) {
                                        console.warn(`Container not found for ${fieldKey}`);
                                        return;
                                    }

                                    formState.sections[sectionKey].fields[fieldKey] = Array.from(container.children)
                                        .map(row => {
                                            const goldInput = row.querySelector('input[data-group="gold-weight"]');
                                            const silverInput = row.querySelector('input[data-group="silver-weight"]');
                                            return {
                                                gold: goldInput ? (goldInput.dataset.rawValue || goldInput.value.replace(/,/g, '')) : '',
                                                silver: silverInput ? (silverInput.dataset.rawValue || silverInput.value.replace(/,/g, '')) : ''
                                            };
                                        })
                                        .filter(({ gold, silver }) => gold || silver); // Only save non-empty rows
                                } else {
                                    const inputs = document.querySelectorAll(`[data-group="${fieldConfig.groupId}"]`);
                                    formState.sections[sectionKey].fields[fieldKey] = Array.from(inputs)
                                        .filter(input => !input.classList.contains('label-input'))
                                        .map(input => {
                                            const labelInput = input.previousElementSibling;
                                            const label = labelInput?.classList.contains('label-input') ? labelInput.value : '';
                                            return {
                                                value: input.dataset.rawValue || input.value.replace(/,/g, ''),
                                                label: label
                                            };
                                        })
                                        .filter(({ value }) => value); // Only save non-empty values
                                }
                            } catch (error) {
                                console.error(`Error saving field ${fieldKey}:`, error);
                            }
                        });
                    });

                    this.setCookie('zakatFormState', formState);
                    console.log('Form state saved successfully');

                    // Update indicator to saved state
                    if (indicator) {
                        indicator.classList.remove('text-blue-500');
                        indicator.classList.add('text-green-500');
                        indicator.querySelector('span').textContent = 'Saved';
                        
                        // Hide indicator after delay
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error saving form state:', error);
                    if (indicator) {
                        indicator.classList.remove('text-blue-500', 'text-gray-500');
                        indicator.classList.add('text-red-500');
                        indicator.querySelector('span').textContent = 'Save failed';
                        
                        // Hide error after longer delay
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 3000);
                    }
                }
            },

            restoreFormState() {
                try {
                    const formState = this.getCookie('zakatFormState');
                    if (!formState) {
                        console.log('No saved form state found, keeping initial fields');
                        return;
                    }

                    console.log('Restoring form state:', formState);

                    // Validate form state structure
                    if (!formState.sections || typeof formState.sections !== 'object') {
                        throw new Error('Invalid form state structure');
                    }

                    // Restore nisab type
                    if (formState.nisabType) {
                        state.setNisabType(formState.nisabType);
                    }

                    // Restore label settings
                    if (formState.enableLabels !== undefined) {
                        state.setEnableLabels(formState.enableLabels);
                        document.getElementById('enable-labels').checked = formState.enableLabels;
                    }

                    // Restore section visibility and field values
                    Object.entries(formState.sections).forEach(([sectionKey, sectionData]) => {
                        const section = document.getElementById(formConfig.sections[sectionKey]?.id);
                        if (!section) {
                            console.warn(`Section ${sectionKey} not found in DOM`);
                            return;
                        }

                        // Set section visibility
                        const toggle = section.querySelector('input[type="checkbox"]');
                        if (toggle) {
                            toggle.checked = sectionData.visible;
                            const content = section.querySelector(`#${formConfig.sections[sectionKey].id}-section`);
                            if (content) {
                                content.classList.toggle('hidden', !sectionData.visible);
                            }
                        }

                        // Restore field values
                        Object.entries(sectionData.fields || {}).forEach(([fieldKey, values]) => {
                            const fieldConfig = formConfig.sections[sectionKey].fields[fieldKey];
                            if (!fieldConfig) {
                                console.warn(`Field ${fieldKey} not found in config`);
                                return;
                            }

                            const container = section.querySelector(
                                fieldConfig.type === 'precious-metals' 
                                    ? `#${fieldConfig.groupId} .precious-metals-container`
                                    : `#${fieldConfig.groupId} .inputs-container`
                            );

                            if (!container) {
                                console.warn(`Container not found for ${fieldKey}`);
                                return;
                            }

                            // Only clear and restore if we have values to restore
                            if (values?.length > 0) {
                                container.innerHTML = '';
                                values.forEach(value => {
                                    const field = fieldConfig.type === 'precious-metals'
                                        ? UI.createPreciousMetalsFields()
                                        : UI.createInputField(fieldConfig.groupId);

                                    if (field) {
                                        if (fieldConfig.type === 'precious-metals') {
                                            const goldInput = field.querySelector('input[data-group="gold-weight"]');
                                            const silverInput = field.querySelector('input[data-group="silver-weight"]');
                                            
                                            if (goldInput && value.gold) {
                                                goldInput.value = value.gold;
                                                goldInput.dataset.rawValue = value.gold;
                                                UI.setupNumberInput(goldInput);
                                            }
                                            if (silverInput && value.silver) {
                                                silverInput.value = value.silver;
                                                silverInput.dataset.rawValue = value.silver;
                                                UI.setupNumberInput(silverInput);
                                            }
                                        } else {
                                            const input = field.querySelector('input:not(.label-input)');
                                            if (input && value.value) {
                                                input.value = value.value;
                                                input.dataset.rawValue = value.value;
                                                UI.setupNumberInput(input);

                                                if (value.label) {
                                                    const labelInput = input.previousElementSibling;
                                                    if (labelInput?.classList.contains('label-input')) {
                                                        labelInput.value = value.label;
                                                    }
                                                }
                                            }
                                        }
                                        container.appendChild(field);
                                    }
                                });
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error restoring form state:', error);
                    this.deleteCookie('zakatFormState');
                }
            }
        };

        // Settings Panel Management
        const SettingsPanel = {
            init() {
                const toggle = document.getElementById('settings-toggle');
                const close = document.getElementById('settings-close');
                const panel = document.getElementById('settings-panel');
                const overlay = document.getElementById('settings-overlay');
                const enableLabels = document.getElementById('enable-labels');

                toggle.addEventListener('click', () => this.open());
                close.addEventListener('click', () => this.close());
                overlay.addEventListener('click', () => this.close());
                enableLabels.addEventListener('change', (e) => state.setEnableLabels(e.target.checked));

                // Close on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.close();
                });
            },

            open() {
                const panel = document.getElementById('settings-panel');
                const overlay = document.getElementById('settings-overlay');
                panel.classList.add('open');
                overlay.classList.add('open');
                document.body.style.overflow = 'hidden';
            },

            close() {
                const panel = document.getElementById('settings-panel');
                const overlay = document.getElementById('settings-overlay');
                panel.classList.remove('open');
                overlay.classList.remove('open');
                document.body.style.overflow = '';
            }
        };

        // FAQ Management
        const FAQ = {
            init() {
                this.renderFAQ();
                this.setupEventListeners();
            },

            renderFAQ() {
                const container = document.getElementById('faq-container');
                if (!container) return;

                container.innerHTML = Object.entries(faqData)
                    .map(([key, section]) => `
                        <div class="mb-6">
                            <button class="faq-section-toggle w-full flex items-center justify-between p-4 bg-white rounded-xl shadow-sm hover:bg-gray-50 transition-colors">
                                <h4 class="text-base font-medium text-gray-800">${section.title}</h4>
                                <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div class="faq-content hidden mt-2 space-y-3">
                                ${section.questions.map(q => `
                                    <div class="bg-white rounded-lg p-4 shadow-sm">
                                        <h5 class="font-medium text-gray-800 mb-2">${q.question}</h5>
                                        <p class="text-sm text-gray-600">${q.answer.replace(/\n/g, '<br>')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
            },

            setupEventListeners() {
                // Panel toggle listeners
                const toggle = document.getElementById('faq-toggle');
                const close = document.getElementById('faq-close');
                const panel = document.getElementById('faq-panel');
                const overlay = document.getElementById('faq-overlay');

                if (toggle && close && panel && overlay) {
                    toggle.addEventListener('click', () => this.open());
                    close.addEventListener('click', () => this.close());
                    overlay.addEventListener('click', () => this.close());

                    // Close on escape key
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') this.close();
                    });
                }

                // FAQ section toggle listeners
                const toggles = document.querySelectorAll('.faq-section-toggle');
                toggles.forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const content = toggle.nextElementSibling;
                        const arrow = toggle.querySelector('svg');
                        
                        // Toggle content visibility
                        content.classList.toggle('hidden');
                        
                        // Rotate arrow
                        arrow.classList.toggle('rotate-180');
                        
                        // Optional: Animate height
                        if (!content.classList.contains('hidden')) {
                            content.style.maxHeight = content.scrollHeight + 'px';
                        } else {
                            content.style.maxHeight = '0';
                        }
                    });
                });
            },

            open() {
                const panel = document.getElementById('faq-panel');
                const overlay = document.getElementById('faq-overlay');
                if (panel && overlay) {
                    panel.classList.add('open');
                    overlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            },

            close() {
                const panel = document.getElementById('faq-panel');
                const overlay = document.getElementById('faq-overlay');
                if (panel && overlay) {
                    panel.classList.remove('open');
                    overlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }
        };

        // UI Components
        const UI = {
            formatNumber(value) {
                if (!value) return '';
                const num = Number(value.replace(/[^\d.]/g, ''));
                return isNaN(num) ? '' : num.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },

            setupNumberInput(input) {
                if (!input) return;
                try {
                    new Cleave(input, {
                        numeral: true,
                        numeralDecimalScale: 2,
                        numeralPositiveOnly: true,
                        prefix: '',
                        delimiter: ',',
                        numeralDecimalMark: '.',
                        onValueChanged: event => {
                            input.dataset.rawValue = event.target.value.replace(/,/g, '');
                        }
                    });
                } catch (error) {
                    console.error('Error setting up number input:', error);
                }
            },

            createButton(type, onClick, className, content) {
                const button = document.createElement('button');
                button.type = type;
                button.className = className;
                button.onclick = onClick;
                button.innerHTML = content;
                return button;
            },

            createInputField(groupId, placeholder = "Enter amount") {
                if (!groupId) return null;
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2 mt-2';
                
                // Add label input if labels are enabled
                if (state.enableLabels) {
                    const labelInput = document.createElement('input');
                    labelInput.type = 'text';
                    labelInput.className = 'label-input w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900';
                    labelInput.placeholder = 'Label';
                    labelInput.dataset.group = groupId;
                    wrapper.appendChild(labelInput);
                }
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = state.enableLabels ? 'w-1/2' : 'w-full';
                input.className += ' p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900';
                input.placeholder = placeholder;
                input.dataset.group = groupId;
                
                UI.setupNumberInput(input);
                
                const removeBtn = UI.createButton(
                    'button',
                    () => wrapper.remove(),
                    'text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded',
                    '−'
                );
                
                wrapper.append(input, removeBtn);
                return wrapper;
            },

            createPreciousMetalsFields() {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2';
                
                // Add label input if labels are enabled
                if (state.enableLabels) {
                    const labelInput = document.createElement('input');
                    labelInput.type = 'text';
                    labelInput.className = 'label-input w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900';
                    labelInput.placeholder = 'Label';
                    labelInput.dataset.group = 'precious-metals-label';
                    wrapper.appendChild(labelInput);
                }
                
                const metalsContainer = document.createElement('div');
                metalsContainer.className = state.enableLabels ? 'w-1/2 flex gap-2' : 'w-full flex gap-2';
                
                ['gold', 'silver'].forEach(type => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-1/2 p-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white';
                    input.placeholder = `${type.charAt(0).toUpperCase() + type.slice(1)} (grams)`;
                    input.dataset.group = `${type}-weight`;
                    UI.setupNumberInput(input);
                    metalsContainer.appendChild(input);
                });
                
                wrapper.appendChild(metalsContainer);
                
                const removeBtn = UI.createButton(
                    'button',
                    () => wrapper.remove(),
                    'text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none focus:outline-none focus:ring-2 focus:ring-red-500 rounded',
                    '−'
                );
                
                wrapper.appendChild(removeBtn);
                return wrapper;
            },

            createLabelWithTooltip(label, tooltip) {
                return `
                    <label class="font-semibold flex items-center">
                        ${label}
                        <div class="relative inline-block ml-2 group">
                            <span class="text-gray-400 group-hover:text-black cursor-pointer">&#9432;</span>
                            <div class="absolute left-0 top-6 bg-gray-800 text-white text-xs rounded p-2 w-48 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                ${tooltip}
                            </div>
                        </div>
                    </label>
                `;
            },

            createSection(sectionId, sectionConfig) {
                const section = document.createElement('div');
                section.id = sectionId;
                section.className = `border rounded-lg p-4 mb-4 ${
                    sectionId.includes('assets') ? 'bg-emerald-50/50' : 
                    sectionId.includes('liabilities') ? 'bg-rose-50/50' : ''
                }`;
                
                const header = document.createElement('div');
                header.className = 'flex items-center justify-between mb-4';
                
                const title = document.createElement('h2');
                title.className = 'text-lg font-semibold';
                title.textContent = sectionConfig.title;
                
                const toggleWrapper = document.createElement('label');
                toggleWrapper.className = 'relative inline-flex items-center cursor-pointer';
                
                const toggle = document.createElement('input');
                toggle.type = 'checkbox';
                toggle.className = 'sr-only peer';
                toggle.checked = sectionConfig.defaultChecked;
                
                const toggleUI = document.createElement('div');
                toggleUI.className = 'w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600';
                
                const content = document.createElement('div');
                content.id = `${sectionId}-section`;
                content.className = 'space-y-4';
                
                if (!sectionConfig.defaultChecked) {
                    content.classList.add('hidden');
                }
                
                toggle.addEventListener('change', () => {
                    content.classList.toggle('hidden', !toggle.checked);
                });
                
                toggleWrapper.append(toggle, toggleUI);
                header.append(title, toggleWrapper);
                section.append(header, content);
                
                return { section, content };
            }
        };

        // Calculation helpers
        const Calculator = {
            getGroupTotal(groupId) {
                if (!groupId) return 0;
                return Array.from(document.querySelectorAll(`[data-group="${groupId}"]`))
                    .reduce((sum, input) => {
                        const value = input.dataset.rawValue || '0';
                        return sum + (Number(value) || 0);
                    }, 0);
            },

            calculateSectionTotals(sectionConfig) {
                return Object.entries(sectionConfig.fields)
                    .map(([_, fieldConfig]) => {
                        let value = 0;
                        let items = [];
                        
                        if (fieldConfig.type === 'precious-metals') {
                            const goldValue = this.getGroupTotal('gold-weight') * state.goldPrice;
                            const silverValue = this.getGroupTotal('silver-weight') * state.silverPrice;
                            value = goldValue + silverValue;
                        } else {
                            const inputs = document.querySelectorAll(`[data-group="${fieldConfig.groupId}"]`);
                            inputs.forEach(input => {
                                if (input.classList.contains('label-input')) return;
                                const itemValue = Number(input.dataset.rawValue || '0');
                                if (itemValue > 0) {
                                    const labelInput = input.previousElementSibling;
                                    const label = labelInput?.classList.contains('label-input') ? labelInput.value : '';
                                    items.push({ label, value: itemValue });
                                    value += itemValue;
                                }
                            });
                        }
                        return { label: fieldConfig.label, value, items };
                    })
                    .filter(({ value }) => value > 0);
            },

            calculateTotalAssets() {
                const goldValue = this.getGroupTotal('gold-weight') * state.goldPrice;
                const silverValue = this.getGroupTotal('silver-weight') * state.silverPrice;
                const otherAssets = Object.entries(formConfig.sections)
                    .filter(([key]) => key.includes('Assets'))
                    .reduce((total, [_, section]) => {
                        return total + Object.values(section.fields)
                            .filter(field => field.type !== 'precious-metals')
                            .reduce((sectionTotal, field) => sectionTotal + this.getGroupTotal(field.groupId), 0);
                    }, 0);
                return goldValue + silverValue + otherAssets;
            },

            calculateTotalLiabilities() {
                return Object.entries(formConfig.sections)
                    .filter(([key]) => key.includes('Liabilities'))
                    .reduce((total, [_, section]) => {
                        return total + Object.values(section.fields)
                            .reduce((sectionTotal, field) => sectionTotal + this.getGroupTotal(field.groupId), 0);
                    }, 0);
            }
        };

        // Main calculation function
        window.calculateZakat = function() {
            if (!state.goldPrice || !state.silverPrice) {
                document.getElementById('result').innerHTML = '<div class="text-red-500">Unable to calculate. Please wait for metal prices to load.</div>';
                return;
            }

            // Save form state before calculating
            CookieManager.saveFormState();

            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            // Generate section rows
            const sectionRows = Object.entries(formConfig.sections)
                .map(([sectionKey, sectionConfig]) => {
                    const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                    const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                    return sectionTotal > 0 ? 
                        `<tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 text-left">${sectionConfig.title}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="text-sm font-medium text-gray-900">$${sectionTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </td>
                        </tr>` : '';
                })
                .join('');

            // Generate business section rows if needed
            const hasBusinessSections = Object.values(formConfig.sections).some(section => 
                section.id.includes('business') && 
                document.getElementById(section.id)?.querySelector('input[type="checkbox"]')?.checked
            );

            const businessRows = hasBusinessSections ? 
                `<tr class="border-t border-gray-200">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 text-left">Total Assets</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="text-sm font-medium text-gray-900">$${totalAssets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </td>
                </tr>
                
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 text-left">Total Liabilities</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="text-sm font-medium text-gray-900">$${totalLiabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </td>
                </tr>` : '';

            // Generate action buttons
            const actionButtons = `
                ${isEligible ? 
                    `<button id="pay-link" onclick="window.location.href='https://darulqasim.org/donate-bb/'" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-emerald-600 hover:to-emerald-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                        Pay Zakat Now
                    </button>` : ''}
                <button onclick="downloadAsExcel()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Excel
                </button>
                <button onclick="downloadAsPDF()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    PDF
                </button>`;

            // Generate final HTML
            const resultHTML = `
                <div class="result-appear space-y-4 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl shadow-sm">
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="w-full">
                            <tbody>
                                ${sectionRows}
                                ${businessRows}
                                <tr class="border-t border-gray-200">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 text-left">Net Wealth</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$${netWealth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900 text-left">Zakat Amount Due</div>
                                        ${!isEligible ? '<div class="text-sm text-gray-500 text-left">(Below Nisab threshold)</div>' : ''}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <div class="text-sm font-medium text-gray-900">$${zakatAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex flex-wrap justify-center gap-3 mt-4">
                        ${actionButtons}
                    </div>
                </div>`;

            document.getElementById('result').innerHTML = resultHTML;
        };

        // Download functions
        function downloadAsExcel() {
            const workbook = XLSX.utils.book_new();
            const sectionsData = [];
            let currentRow = 0;

            // Add title and date
            sectionsData.push(
                ['Zakat Calculation Report'],
                [`Generated on: ${new Date().toLocaleString()}`],
                []
            );
            currentRow += 3;

            // Add sections with pre-calculated values
            Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                if (sectionTotals.length === 0) return;

                sectionsData.push([sectionConfig.title]);
                currentRow++;

                sectionTotals.forEach(({ label, value, items }) => {
                    if (state.enableLabels && items) {
                        items.forEach(({ label: itemLabel, value: itemValue }) => {
                            const displayLabel = itemLabel ? `${label} - ${itemLabel}` : label;
                            sectionsData.push(['', displayLabel, itemValue]);
                            currentRow++;
                        });
                    } else {
                        sectionsData.push(['', label, value]);
                        currentRow++;
                    }
                });

                const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                sectionsData.push(['', 'Total', sectionTotal]);
                currentRow++;
                sectionsData.push([]);
                currentRow++;
            });

            // Add summary section with pre-calculated values
            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            sectionsData.push(
                ['Summary'],
                ['', 'Total Assets', totalAssets],
                ['', 'Total Liabilities', totalLiabilities],
                ['', 'Net Wealth', netWealth]
            );
            currentRow += 4;

            // Add Zakat section with pre-calculated values
            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            sectionsData.push(
                ['Zakat Status'],
                ['', 'Zakat Amount Due', zakatAmount]
            );

            // Create and format worksheet
            const sectionsSheet = XLSX.utils.aoa_to_sheet(sectionsData);
            sectionsSheet['!cols'] = [{ wch: 20 }, { wch: 40 }, { wch: 15 }];

            // Set cell types and formats
            for (let R = 0; R < sectionsData.length; R++) {
                for (let C = 0; C < sectionsData[R].length; C++) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    
                    if (C === 2 && R > 2) {
                        const value = sectionsData[R][C];
                        sectionsSheet[cell_ref] = {
                            t: 'n',
                            v: value,
                            z: '#,##0.00'
                        };
                    }
                }
            }

            XLSX.utils.book_append_sheet(workbook, sectionsSheet, 'Zakat Calculation');
            XLSX.writeFile(workbook, 'zakat_calculation.xlsx');
        }

        function downloadAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            // Add title and date
            doc.setFontSize(20);
            doc.text('Zakat Calculation Report', 20, y);
            y += 20;

            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, y);
            y += 15;

            // Add sections
            Object.entries(formConfig.sections).forEach(([sectionKey, sectionConfig]) => {
                const sectionTotals = Calculator.calculateSectionTotals(sectionConfig);
                const sectionTotal = sectionTotals.reduce((sum, { value }) => sum + value, 0);
                if (sectionTotal === 0) return;

                doc.setFontSize(14);
                doc.text(sectionConfig.title, 20, y);
                y += 10;

                doc.setFontSize(12);
                sectionTotals.forEach(({ label, value, items }) => {
                    if (state.enableLabels && items) {
                        items.forEach(({ label: itemLabel, value: itemValue }) => {
                            const displayLabel = itemLabel ? `${label} - ${itemLabel}` : label;
                            doc.text(displayLabel, 30, y);
                            doc.text(`$${itemValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                            y += 8;
                        });
                    } else {
                        doc.text(label, 30, y);
                        doc.text(`$${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                        y += 8;
                    }
                });

                doc.text('Total', 30, y);
                doc.text(`$${sectionTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 15;
            });

            // Add summary
            const totalAssets = Calculator.calculateTotalAssets();
            const totalLiabilities = Calculator.calculateTotalLiabilities();
            const netWealth = totalAssets - totalLiabilities;

            doc.setFontSize(14);
            doc.text('Summary', 20, y);
            y += 10;

            doc.setFontSize(12);
            if (totalAssets > 0) {
                doc.text('Total Assets', 30, y);
                doc.text(`$${totalAssets.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 8;
            }

            if (totalLiabilities > 0) {
                doc.text('Total Liabilities', 30, y);
                doc.text(`$${totalLiabilities.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
                y += 8;
            }

            doc.text('Net Wealth', 30, y);
            doc.text(`$${netWealth.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
            y += 15;

            // Add Zakat amount
            const nisabType = window.selectedNisabType;
            const nisabThreshold = nisabType === 'gold' 
                ? CONSTANTS.GOLD_NISAB_GRAMS * state.goldPrice 
                : CONSTANTS.SILVER_NISAB_GRAMS * state.silverPrice;

            const isEligible = netWealth >= nisabThreshold;
            const zakatAmount = isEligible ? netWealth * CONSTANTS.ZAKAT_RATE : 0;

            doc.setFontSize(14);
            if (isEligible) {
                doc.text('Zakat Amount Due', 20, y);
                y += 10;
                doc.setFontSize(16);
                doc.text(`$${zakatAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, 150, y);
            } else {
                doc.text('Zakat Status', 20, y);
                y += 10;
                doc.setFontSize(12);
                doc.text('Not eligible - Wealth below Nisab threshold', 30, y);
            }

            doc.save('zakat_calculation.pdf');
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize core functionality
            setNisabType('gold');
            state.updatePrices();
            setInterval(state.updatePrices, 300000); // Update every 5 minutes
            
            // Initialize settings panel
            SettingsPanel.init();
            
            // Initialize FAQ
            FAQ.init();
            
            // Initialize form
            const form = document.getElementById('zakat-form');
            if (!form) return;
            
            // Clear existing content
            form.innerHTML = '';
            
            // Create all sections
            Object.entries(formConfig.sections).forEach(([_, sectionConfig]) => {
                const { section, content } = UI.createSection(sectionConfig.id, sectionConfig);
                
                // Create fields for each section
                Object.entries(sectionConfig.fields).forEach(([_, fieldConfig]) => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.id = fieldConfig.groupId;
                    fieldDiv.className = 'mb-4';
                    
                    const labelContainer = document.createElement('div');
                    labelContainer.className = 'flex items-center justify-between mb-2';
                    labelContainer.innerHTML = UI.createLabelWithTooltip(fieldConfig.label, fieldConfig.tooltip);
                    
                    const addButton = UI.createButton(
                        'button',
                        () => {
                            const newField = fieldConfig.type === 'precious-metals' 
                                ? UI.createPreciousMetalsFields() 
                                : UI.createInputField(fieldConfig.groupId);
                            container.appendChild(newField);
                        },
                        'text-green-500 hover:text-green-700 w-6 h-6 flex items-center justify-center text-xl font-bold leading-none',
                        '+'
                    );
                    
                    labelContainer.appendChild(addButton);
                    
                    const container = document.createElement('div');
                    container.className = fieldConfig.type === 'precious-metals' 
                        ? 'precious-metals-container space-y-2' 
                        : 'inputs-container space-y-2';
                    
                    const initialField = fieldConfig.type === 'precious-metals'
                        ? UI.createPreciousMetalsFields()
                        : UI.createInputField(fieldConfig.groupId);
                    
                    if (initialField) {
                        container.appendChild(initialField);
                    }
                    
                    fieldDiv.appendChild(labelContainer);
                    fieldDiv.appendChild(container);
                    content.appendChild(fieldDiv);
                });
                
                form.appendChild(section);
            });
            
            // Add calculate button
            const calculateButton = UI.createButton(
                'button',
                window.calculateZakat,
                'w-full bg-blue-500 text-white p-2 rounded font-semibold hover:bg-blue-600 mt-4',
                'Calculate'
            );
            calculateButton.id = 'calculate-button';
            form.appendChild(calculateButton);
            
            // Set form as initialized
            window.isFormInitialized = true;
            
            // Wait a brief moment before restoring state to ensure DOM is ready
            setTimeout(() => {
                CookieManager.restoreFormState();
            }, 100);
            
            // Debounced form state saving
            const debounce = (fn, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn(...args), delay);
                };
            };

            const debouncedSave = debounce(() => {
                if (window.isFormInitialized) {
                    CookieManager.saveFormState();
                }
            }, 1000);

            // Event listeners
            const updateSaveIndicator = () => {
                const indicator = document.getElementById('autosave-indicator');
                if (indicator) {
                    indicator.style.opacity = '1';
                    indicator.classList.remove('text-green-500', 'text-gray-500');
                    indicator.classList.add('text-blue-500');
                    indicator.querySelector('span').textContent = 'Saving...';
                }
                debouncedSave();
            };

            // Listen for all relevant form changes
            document.addEventListener('input', e => {
                if (e.target.matches('input[type="text"]')) {
                    updateSaveIndicator();
                }
            });

            document.addEventListener('change', e => {
                if (e.target.matches('input[type="checkbox"]')) {
                    updateSaveIndicator();
                }
            });
        });

        function setNisabType(type) {
            if (!['gold', 'silver'].includes(type)) return;
            
            const elements = {
                gold: {
                    check: document.getElementById('gold-check'),
                    card: document.querySelector('[data-type="gold"]')
                },
                silver: {
                    check: document.getElementById('silver-check'),
                    card: document.querySelector('[data-type="silver"]')
                }
            };
            
            Object.entries(elements).forEach(([metal, { check, card }]) => {
                check.classList.toggle('hidden', metal !== type);
                card.querySelector('.border-2').classList.toggle(
                    metal === 'gold' ? 'border-yellow-500' : 'border-gray-400',
                    metal === type
                );
            });
            
            window.selectedNisabType = type;
            if (document.getElementById('result').innerHTML) {
                window.calculateZakat();
            }
        }
    </script>
</body>
</html>
